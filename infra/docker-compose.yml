version: '3.9'

services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: castaway_council
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres']
      interval: 10s
      timeout: 5s
      retries: 5

  # Supabase local stack
  supabase-db:
    image: supabase/postgres:15.1.0.147
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    ports:
      - '54322:5432'
    volumes:
      - supabase_db_data:/var/lib/postgresql/data

  supabase-studio:
    image: supabase/studio:20240101-8e4a094
    environment:
      SUPABASE_URL: http://kong:8000
      STUDIO_PG_META_URL: http://meta:8080
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE}
    ports:
      - '54323:3000'

  kong:
    image: kong:2.8.1
    environment:
      KONG_DATABASE: 'off'
      KONG_DECLARATIVE_CONFIG: /var/lib/kong/kong.yml
      KONG_DNS_ORDER: LAST,A,CNAME
      KONG_PLUGINS: request-transformer,cors,key-auth,acl
    ports:
      - '54321:8000'
      - '54324:8443'
    volumes:
      - ./supabase/kong.yml:/var/lib/kong/kong.yml:ro

  # Temporal
  temporal:
    image: temporalio/auto-setup:1.22.4
    environment:
      - DB=postgresql
      - DB_PORT=5432
      - POSTGRES_USER=postgres
      - POSTGRES_PWD=postgres
      - POSTGRES_SEEDS=postgres
      - DYNAMIC_CONFIG_FILE_PATH=config/dynamicconfig/development-sql.yaml
    ports:
      - '7233:7233'
    depends_on:
      postgres:
        condition: service_healthy

  temporal-ui:
    image: temporalio/ui:2.22.3
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CORS_ORIGINS=http://localhost:3000
    ports:
      - '8080:8080'
    depends_on:
      - temporal

  # Main web application
  web:
    build:
      context: ..
      dockerfile: infra/Dockerfile.web
    environment:
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/castaway_council
      NEXT_PUBLIC_SUPABASE_URL: http://localhost:54321
      TEMPORAL_ADDRESS: temporal:7233
      NODE_ENV: development
    ports:
      - '3000:3000'
    volumes:
      - ..:/app
      - /app/node_modules
      - /app/.next
    depends_on:
      postgres:
        condition: service_healthy
      temporal:
        condition: service_started

  # Temporal worker
  temporal-worker:
    build:
      context: ..
      dockerfile: infra/Dockerfile.temporal
    environment:
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/castaway_council
      TEMPORAL_ADDRESS: temporal:7233
      NODE_ENV: development
    volumes:
      - ..:/app
      - /app/node_modules
    depends_on:
      postgres:
        condition: service_healthy
      temporal:
        condition: service_started

volumes:
  postgres_data:
  supabase_db_data:
